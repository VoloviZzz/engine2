<link rel="stylesheet" href="/css/shops-list.css">
<section>
	<div class="map-yandex">
		<!--<iframe src="https://yandex.ru/map-widget/v1/?um=constructor%3A4744011d5fe5b89cb747635576a0b9e591a824f2540798302f69ee16b2d92a7b&amp;source=constructor" width="100%" height="300" frameborder="0"></iframe>-->
		<div style="width:100%; height:300px;" id="shops-map"></div>
		<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAwz7Whv_9Vs1rF3lPqyLsRlxarfSiFs8g"></script>
		<script>
			
			function initMap() {

				var map = new google.maps.Map(document.getElementById('shops-map'), {
						zoom: 14,
						center: {lat: 53.402709, lng: 59.027477}, 
					}),
					bounds = new google.maps.LatLngBounds,
					markers = 0;
				
				$('.shops-item').each((i, item) => {
					item = $(item);
					var id = item.data('id'),
						coord = item.data('coord'),
						title = item.data('title'),
						addr = item.data('addr');
					if (coord !== "") {
						markers++;
						coord = coord.split(',');
						var pos = new google.maps.LatLng(parseFloat(coord[0]), parseFloat(coord[1]));
						var marker = new google.maps.Marker({ position: pos, map: map, });
						
						var contentString = '<h1 class="text-center">' + (title !== "" ? title : "Магазин без названия") + '</h1><h4 class="text-center" style="color:grey;">' + (addr !== "" ? addr : "адрес не указан") + '</h4><h5 class="text-center" style="color:grey;">' + coord.join(', ') + '</h5><h5 class="text-center"><a href="/shop-page/' + id + '" class="btn">Открыть</a></h5>';
						
						var infowindow = new google.maps.InfoWindow({content: contentString, maxWidth: 200 });
						
						infowindow.open(map, marker);
						bounds.extend(pos);
					}
				});

				if (markers > 0) map.fitBounds(bounds);
				
			}

			window.onload = initMap;

		</script>
	</div>
		<% if(user.adminMode) { %>
		<div class="text-right">
			<button class="btn js-add-shopItem">Добавить магазин</button>
		</div>
	<% } %>
	<div class="shops-items">
		<% shops.forEach((shop) => { %>
			<div class="shops-item" data-id="<%= shop.id -%>" data-coord="<%= shop.coords %>" data-title="<%= shop.title -%>" data-addr="<%= shop.address -%>">
				<% if(user.adminMode) { %>
					<div class="text-right">
						<button data-id="<%= shop.id -%>" class="btn js-delete-shopItem">Удалить из списка</button>
					</div>
				<% } %>
				<a class="page-link" href="/shop-page/<%= shop.id -%>">
					<h1 class="shops-item__title"><%= shop.title -%></h1>
				</a>
				<a class="shops-item__image" href="/shop-page/<%= shop.id -%>">
					<img class="setResponsiveHeight" src="<%= Helpers.replaceImageIfNotExist(shop.main_photo) -%>" alt="">
				</a>
				<div class="shops-item__text text-margin-bottom-p text-indent">
					<%- Helpers.replaceLineBreaks(Helpers.trimStr(shop.text, 175)) -%>
				</div>
				<div class="shops-item__text text-margin-bottom-p text-indent">
					<span class="shops-item__adress">Адрес: <%= shop.address -%></span>
					<span class="shops-item__phone">Телефон: <%= shop.phones -%></span>
				</div>
				<div class="shops-item__more">
					<a class="page-link" href="/shop-page/<%= shop.id -%>">Подробнее...</a>
				</div>
			</div>
		<% }) %>
	</div>
</section>
<% if(user.adminMode) { %>
	<script src="/admins/js/shops-list.js" defer></script>
<% } %>